<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera PWA – Filters & Grain</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link rel="icon" href="data:,">
  <style>
    :root{color-scheme:dark}
    *{box-sizing:border-box}
    body{
      margin:0;background:#000;height:100vh;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-family:sans-serif;color:#fff;overflow:hidden
    }

    /* live preview & captured photo */
    #camera-view,#photo-output{
      width:100%;max-width:480px;aspect-ratio:3/4;
      object-fit:cover;background:#000
    }

    /* translucent MENU button */
    #menu-btn{
      position:absolute;top:12px;right:12px;width:44px;height:44px;
      border-radius:50%;background:rgba(255,255,255,.15);
      display:flex;align-items:center;justify-content:center;
      font-size:26px;color:#fff;cursor:pointer;z-index:20;
      backdrop-filter:blur(6px)
    }

    /* translucent SHUTTER button */
    #shutter{
      position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
      width:70px;height:70px;border-radius:50%;border:3px solid #fff;
      background:rgba(255,255,255,.2);cursor:pointer;z-index:10;
      backdrop-filter:blur(6px);font-size:0
    }
    #shutter:disabled{opacity:.4;cursor:default}

    canvas{display:none}

    /* control panel */
    #controls{
      position:absolute;left:50%;bottom:20px;transform:translate(-50%,100%);
      width:calc(100% - 24px);max-width:480px;
      background:rgba(0,0,0,.85);padding:14px;border-radius:14px;
      display:flex;flex-direction:column;gap:10px;z-index:15;
      backdrop-filter:blur(8px);
      transition:transform .3s ease-out,opacity .3s ease-out;
      opacity:0;pointer-events:none;
    }
    #controls.show{
      transform:translate(-50%,0);
      opacity:1;pointer-events:auto;
    }

    label{width:100%;font-size:14px}
    input[type=range],select{width:100%}
    small{font-size:12px;opacity:.7;text-align:center}
  </style>
</head>
<body>

  <!-- live preview & captured image -->
  <video id="camera-view" autoplay playsinline></video>
  <img   id="photo-output" style="display:none">

  <!-- overlay UI -->
  <div id="menu-btn">☰</div>
  <button id="shutter" disabled aria-label="Take photo"></button>

  <!-- hidden drawing surface -->
  <canvas id="canvas"></canvas>

  <!-- slide-in controls -->
  <div id="controls">
    <label>Simulated ISO (<span id="iso-val">200</span>)
      <input type="range" id="iso"  min="50" max="400" step="50" value="200">
    </label>

    <label>Filter
      <select id="filter">
        <option value="none">None</option>
        <option value="monochrome">Monochrome</option>
        <option value="warm">Warm</option>
        <option value="cool">Cool</option>
        <option value="highContrast">High Contrast</option>
        <option value="vintage">Vintage</option>
      </select>
    </label>

    <label>Film Grain (<span id="grain-val">0</span>)
      <input type="range" id="grain" min="0" max="50" step="5" value="0">
    </label>

    <small>Game-pad: D-pad ↑/↓ = ISO  |  A = shutter</small>
  </div>

<script>
/* element refs */
const video   = document.getElementById('camera-view');
const canvas  = document.getElementById('canvas');
const photo   = document.getElementById('photo-output');
const isoRng  = document.getElementById('iso');
const isoLbl  = document.getElementById('iso-val');
const filter  = document.getElementById('filter');
const grainR  = document.getElementById('grain');
const grainLbl= document.getElementById('grain-val');
const shutter = document.getElementById('shutter');
const panel   = document.getElementById('controls');
const menuBtn = document.getElementById('menu-btn');

/* state */
let iso=+isoRng.value, grain=+grainR.value;
let padIdx=null, lastPad=0;

/* ---- camera ---- */
(async ()=>{
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=s;
    video.onloadedmetadata=()=>shutter.disabled=false;
  }catch(e){alert('Camera error: '+e.message);}
})();

/* ---- UI ---- */
isoRng.oninput  =()=>{iso=+isoRng.value; isoLbl.textContent=iso};
grainR.oninput  =()=>{grain=+grainR.value; grainLbl.textContent=grain};
menuBtn.onclick =()=>panel.classList.toggle('show');
shutter.onclick = snap;

/* ---- snapshot ---- */
function snap(){
  const w=video.videoWidth, h=video.videoHeight;
  if(!w||!h){alert('Camera not ready'); return;}

  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  const img=ctx.getImageData(0,0,w,h),d=img.data;
  const bright=iso/200;

  for(let i=0;i<d.length;i+=4){
    let r=d[i]*bright, g=d[i+1]*bright, b=d[i+2]*bright;

    switch(filter.value){
      case 'monochrome':{const avg=(r+g+b)/3; r=g=b=avg; break;}
      case 'warm':  r+=20; b-=10; break;
      case 'cool':  r-=10; b+=20; break;
      case 'highContrast':{const c=1.5; r=((r-128)*c)+128; g=((g-128)*c)+128; b=((b-128)*c)+128; break;}
      case 'vintage': r=r*1.1+10; g=g*0.9; b=b*0.8; break;
    }

    if(grain){
      const n=(Math.random()-0.5)*2*grain;
      r+=n; g+=n; b+=n;
    }

    d[i]  =Math.max(0,Math.min(255,r));
    d[i+1]=Math.max(0,Math.min(255,g));
    d[i+2]=Math.max(0,Math.min(255,b));
  }
  ctx.putImageData(img,0,0);
  photo.src=canvas.toDataURL('image/png');
  photo.style.display='block';
  video.style.display='none';
}

/* ---- game-pad ---- */
window.addEventListener('gamepadconnected',e=>padIdx=e.gamepad.index);
window.addEventListener('gamepaddisconnected',()=>padIdx=null);
(function poll(){
  if(padIdx!==null){
    const gp=navigator.getGamepads()[padIdx];
    if(gp){
      const t=performance.now();
      if(gp.buttons[12].pressed && t-lastPad>250){
        iso=Math.min(400,iso+50); isoRng.value=isoLbl.textContent=iso; lastPad=t;
      }
      if(gp.buttons[13].pressed && t-lastPad>250){
        iso=Math.max(50,iso-50); isoRng.value=isoLbl.textContent=iso; lastPad=t;
      }
      if(gp.buttons[0].pressed && t-lastPad>300){
        shutter.click(); lastPad=t;
      }
    }
  }
  requestAnimationFrame(poll);
})();
</script>
</body>
</html>
