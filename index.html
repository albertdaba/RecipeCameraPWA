<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera PWA with Filters & Grain</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link rel="icon" href="data:,">
  <style>
    :root{color-scheme:dark}
    body{
      margin:0;background:#000;height:100vh;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-family:sans-serif;color:#fff;overflow:hidden
    }
    #camera-view,#photo-output{
      width:100%;max-width:480px;aspect-ratio:3/4;
      object-fit:cover;background:#000
    }
    #controls{
      width:100%;max-width:480px;padding:10px;box-sizing:border-box;
      display:flex;flex-direction:column;gap:6px
    }
    label{width:100%}
    input[type=range],select{width:100%}
    #shutter{
      padding:15px 30px;font-size:18px;border:none;border-radius:12px;
      background:#fff;color:#000;cursor:pointer
    }
    canvas{display:none}
    small{font-size:12px;opacity:.7}
  </style>
</head>
<body>

  <video id="camera-view" autoplay playsinline></video>
  <img   id="photo-output" style="display:none">
  <canvas id="canvas"></canvas>

  <div id="controls">
    <label>Simulated ISO (<span id="iso-val">200</span>)
      <input type="range" id="iso"  min="50" max="400" step="50" value="200">
    </label>

    <label>Filter
      <select id="filter">
        <option value="none">None</option>
        <option value="monochrome">Monochrome</option>
        <option value="warm">Warm</option>
        <option value="cool">Cool</option>
        <option value="highContrast">High Contrast</option>
        <option value="vintage">Vintage</option>
      </select>
    </label>

    <label>Film Grain (<span id="grain-val">0</span>)
      <input type="range" id="grain" min="0" max="50" step="5" value="0">
    </label>

    <button id="shutter" disabled>ðŸ“¸ Take Photo (A button)</button>
    <small>Gamepad: D-pad â†‘/â†“ = ISO, A = shutter</small>
  </div>

<script>
/* element refs */
const video   = document.getElementById('camera-view');
const canvas  = document.getElementById('canvas');
const photo   = document.getElementById('photo-output');
const isoRng  = document.getElementById('iso');
const isoLbl  = document.getElementById('iso-val');
const filter  = document.getElementById('filter');
const grainR  = document.getElementById('grain');
const grainLbl= document.getElementById('grain-val');
const shutter = document.getElementById('shutter');

/* state */
let iso      = +isoRng.value;
let grainAmt = +grainR.value;
let padIdx   = null, lastPad=0;

/* camera */
async function initCam(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=s;
  }catch(e){alert('Camera error: '+e.message);}
}
video.addEventListener('loadedmetadata',()=>shutter.disabled=false);

/* ui handlers */
isoRng.oninput = ()=>{ iso=+isoRng.value; isoLbl.textContent=iso };
grainR.oninput = ()=>{ grainAmt=+grainR.value; grainLbl.textContent=grainAmt };
shutter.onclick= snap;

/* snap function */
function snap(){
  const w=video.videoWidth,h=video.videoHeight;
  if(!w||!h){alert('Camera not ready');return;}
  canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  const img=ctx.getImageData(0,0,w,h),d=img.data;
  const expo=iso/200;                    // brightness factor

  for(let i=0;i<d.length;i+=4){
    let r=d[i]*expo, g=d[i+1]*expo, b=d[i+2]*expo;

    switch(filter.value){
      case 'monochrome':{
        const avg=(r+g+b)/3; r=g=b=avg; break;}
      case 'warm':  r+=20; b-=10; break;
      case 'cool':  r-=10; b+=20; break;
      case 'highContrast':{
        const c=1.5; r=((r-128)*c)+128; g=((g-128)*c)+128; b=((b-128)*c)+128; break;}
      case 'vintage': r=r*1.1+10; g=g*0.9; b=b*0.8; break;
    }

    /* grain */
    if(grainAmt){
      const n=(Math.random()-0.5)*2*grainAmt;
      r+=n; g+=n; b+=n;
    }

    /* clamp */
    d[i]=Math.max(0,Math.min(255,r));
    d[i+1]=Math.max(0,Math.min(255,g));
    d[i+2]=Math.max(0,Math.min(255,b));
  }
  ctx.putImageData(img,0,0);
  photo.src=canvas.toDataURL('image/png');
  photo.style.display='block';
  video.style.display='none';
}

/* gamepad */
window.addEventListener('gamepadconnected',e=>{padIdx=e.gamepad.index});
window.addEventListener('gamepaddisconnected',()=>padIdx=null);
function pollPad(){
  if(padIdx!==null){
    const gp=navigator.getGamepads()[padIdx];
    if(gp){
      const t=performance.now();
      if(gp.buttons[12].pressed&&t-lastPad>250){ iso=Math.min(400,iso+50); isoRng.value=isoLbl.textContent=iso; lastPad=t;}
      if(gp.buttons[13].pressed&&t-lastPad>250){ iso=Math.max(50, iso-50); isoRng.value=isoLbl.textContent=iso; lastPad=t;}
      if(gp.buttons[0].pressed && t-lastPad>300){ shutter.click(); lastPad=t;}
    }
  }
  requestAnimationFrame(pollPad);
}
requestAnimationFrame(pollPad);

/* start */
initCam();
</script>
</body>
</html>
